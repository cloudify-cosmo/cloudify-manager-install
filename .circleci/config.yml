version: 2
jobs:
  build:
    machine: true

    working_directory: ~/cloudify-manager-install

    environment:
      - CONTAINER_NAME: cfy_manager
      - IMAGE_NAME: cfy_manager_image
      - REMOTE_PATH: /root/cloudify-manager-install

    steps:
      - checkout
      # Running this step in the background allows us to run it in parallel
      - run:
          name: Python tests
          background: true
          command: |
            pip install tox
            tox -e flake8
            tox -e py27
      - run:
          name: Build and run base container
          command: |
            cd packaging/docker

            docker build -q --tag ${IMAGE_NAME} .
            docker run --name ${CONTAINER_NAME} -d -v /sys/fs/cgroup:/sys/fs/cgroup:ro --tmpfs /run --tmpfs /run/lock --security-opt seccomp:unconfined --cap-add SYS_ADMIN ${IMAGE_NAME}
            docker cp ~/cloudify-manager-install ${CONTAINER_NAME}:${REMOTE_PATH}

            docker exec -d ${CONTAINER_NAME} sh -c "systemctl start sshd"
      - run:
          name: Create RPM
          command: |
            docker exec -t ${CONTAINER_NAME} sh -c "${REMOTE_PATH}/packaging/docker/build_rpm.sh"
      - run:
          name: Install Cloudify Manager
          command: |
            cd packaging/docker

            chmod +x install_manager.sh
            ./install_manager.sh
