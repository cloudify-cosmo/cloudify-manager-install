version: 2
jobs:
  build:
    machine: true

    working_directory: ~/cloudify-manager-install

    environment:
      - CONTAINER_NAME: cfy_manager

    steps:
      - checkout
      # Running this step in the background allows us to run it in parallel
      - run:
          name: Python tests
          background: true
          command: |
            pip install tox
            tox -e flake8
            tox -e py27
      - run:
          name: Build and run base container
          command: |
            cd packaging/docker

            docker build -q --tag cfy_manager_image .
            docker run --name cfy_manager -d -v /sys/fs/cgroup:/sys/fs/cgroup:ro --tmpfs /run --tmpfs /run/lock --security-opt seccomp:unconfined --cap-add SYS_ADMIN cfy_manager_image
      - run:
          name: Create RPM
          command: |
            cd packaging/docker

            chmod +x build_rpm.sh
            ./build_rpm.sh
      - run:
          name: Install Cloudify Manager
          command: |
            cd packaging/docker

            chmod +x install_manager.sh
            ./install_manager.sh
